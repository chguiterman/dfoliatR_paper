---
title: "*dfoliatR*: An R package for detection and analysis of insect defoliation signals in tree rings"
author:
  - name: Christopher H. Guiterman
    email: chguiterman@email.arizona.edu
    affiliation: a,b
    footnote: 1
  - name: Ann M. Lynch
    email: lyncha@email.arizona.edu
    affiliation: a,c
    # footnote: [2, 3]
  - name: Jodi N. Axelson
    email: jodi.axelson@berkeley.edu
    affiliation: c
    # footnote: 4
address:
  - code: a
    address: "Laboratory of Tree-Ring Research, University of Arizona, 1215 E Lowell St. Box 210045, Tucson, AZ, 85721"
  - code: b
    address: "Three Pines Forest Research, LLC, PO Box 225, Etna, NH, 03750"
  - code: c
    address: "U.S. Forest Service, Rocky Mountain Research Station, 1215 E Lowell St. Box 210045, Tucson, AZ, 85721"
  - code: d
    address: "Dept of Environmental Science, Policy & Management, University of California, Berkeley, Berkeley, CA 94720"
footnote:
  - code: 1
    text: "Corresponding Author"
#   - code: 2
#     text: "Laboratory of Tree-Ring Research, University of Arizona, 1215 E Lowell St. Box 210045, Tucson, AZ, 85721"
#   - code: 3
#     text: "U.S. Forest Service, Rocky Mountain Research Station, 1215 E Lowell St. Box 210045, Tucson, AZ, 85721"
#   - code: 4
#     text: "Dept of Environmental Science, Policy & Management, University of California, Berkeley, Berkeley, CA 94720"
abstract: |
  We present a new R package to provide dendroecologists with tools to infer, quantify, analyze, and visualize growth suppression events in tree rings caused by insect defoliation. The ‘dfoliatR’ library is based on the FORTRAN V program OUTBREAK, and builds on existing resources in the R computing environment. ‘dfoliatR’ expands on OUTBREAK to provide greater control of suppression thresholds, additional output tables, and high-quality graphics. To use ‘dfoliatR’ requires standardized ring-width measurements from insect host trees and an indexed tree-ring chronology from local non-host trees. It performs an indexing procedure to remove the climatic signal represented in the non-host chronology from the host-tree series. It then infers defoliation events in individual trees. Site-level analyses identify outbreak events that synchronously affect a user-defined number or proportion of the host trees. Functions are available for summary statistics and graphics of tree- and site-level series. 
    
    \hfill\break
keywords: |
  Dendroecology, spruce budworm, Choristoneura, pandora moth, Coloradia pandora Blake, larch-bud-moth
  \newpage
journal: "Tree-Ring Research"
date: "`r Sys.Date()`"
bibliography: mybibfile.bib
linenumbers: true
#numbersections: true
csl: ecology.csl
output: rticles::elsevier_article
# output:
#   bookdown::word_document2:
#     reference_docx: "../common/word-styles-reference-01.docx"
#     toc: false
#     toc_depth: 2
#     fig_caption: yes
#     df_print: kable
layout: review
preamble: |
  \usepackage{amsmath}
---


Introduction
==========================

Variation in the width and morphology of annual radial growth rings in wood permits dating and quantification of past forest insect defoliator outbreaks. Defoliation can be distinguished from climate- and other disturbance-related influences by comparing ring-width or other annually-resolved features in the wood of host species to non-host species or to climate records. The effect of defoliation on radial growth of trees has been recognized since the mid-1800s, but work prior to the 1980s was not cross-dated (based on annually-resolved and –dated measurements), not standardized (quantitatively controlled for tree geometry and age effects), and suffered from inadequate extraction of the defoliation-related variability from variability associated with climate and other factors [@Swetnam1985; @Speer2010; @Lynch2012].  These and other problems may be circumvented by appropriate use of dendrochronological techniques.  Quantitative methodology to infer forest defoliator outbreaks from cross-dated tree-ring records was developed in the 1980s by @Swetnam1985 for developing western spruce budworm chronologies [@Swetnam1989; @Swetnam1993].  The methodology has since been successfully applied to a wide range of defoliator species, most of which are conifer herbivores, and has evolved in sophistication and application to a wide range of ecosystem situations [@Lynch2012].

The main dendrochronological tool for inferring, dating, and quantifying defoliator outbreaks from tree-ring records has been the software routine OUTBREAK [@Swetnam1985; @outbreak; @Swetnam1989].  OUTBREAK computes indices (described later in detail) of suppressed growth by subtracting a detrended and standardized climate series (a “control” chronology, usually a site chronology developed from non-host trees or a gridded climate data point series) from host individual-tree detrended and standardized radial growth series after the host and non-host series have been brought to a common variance. If the host and non-host species respond similarly to climate (which can be tested), the derived series retains variability that the host and non-host series do not have in common, generally the insect signal and noise (unexplained variability).  The user defines a rule base specifying the magnitude and duration that a period of indexed growth suppression must meet or surpass for a period of suppressed growth to be inferred as a defoliation event at the tree level.  

Though powerful, OUTBREAK is outdated and increasingly difficult to use in modern computing environments.  It was written in Fortran V with inherently severe restrictions, as RAM and disk space were limited at that time (256 kb and 10 MB, respectively) and Fortran conventions imposed very strict formatting, file naming, and output conventions.  Windows-based execution operates in a DOS window, Apple-based xxx in xxx, and provides no graphical interface or capabilities.  Barriers to batch operation impose burdens for analyses of larger data sets.  We developed dfoliaR as an `R`- and `dplR`-based routine to overcome these issues.

`dfoliatR` adds to a growing suite of dendrochronology packages the `R` computing environment [@RCore]. Stemming from the `dplR` library [@Bunn2008] that enables `R` users to read and write an array of tree-ring data formats, standardize ring width series, build and evaluate chronologies, and perform quality control (to name a few), one can now also measure ring widths from scanned images of preparred samples [@Shi2019; @Lara2015], perform and check crossdating [@Bunn2010], and perform many analytical tests [@Jevsenak2018; @Zang2015]. Tools for assessing stand dynamics and disturbance analyses are under rapid development, with new packages for assessing growth and release events [`TRADER`: @Altman2014], metrics of growth resilience [`pointRes`: @VanderMaaten-Theunissen2015], and fire history [`burnr`: @Malevich2018]. The key objective of `dfoliatR` is to provide tools to identify and analyze insect defoliation and outbreak events by building on the methods employed by OUTBREAK. It capitilizes on the robust software already available in `R` by using `dplR` data formats for incoming tree-ring series and providing output data formats embodied by the `tidyverse` [@Wickham2019] that include efficient data manipulation [`dplyr`: @Wickham2020dplyr] and graphics [`ggplot2`: @wickham2016ggplot2].  

In this paper, we describe the statistical methods employed by `dfoliatR`, its availability, compare results to those produced by OUTBREAK, and present an example analyses. Users need not have much experience in `R` to replicate the analyses and graphics as presented. The `R` code presented below is executable in an `R` session once the required libraries are installed and loaded. Support documentation in addition to this paper is provided within the package via standard help menus (accessed by typing `?` before a function name) and on the package website ([https://chguiterman.github.io/dfoliatR/](https://chguiterman.github.io/dfoliatR/)), which includes up-to-date vignettes that describe in detail the functionality of the software. Code to create a preprint of this manuscript including the `R` scripts is available from [https://github.com/chguiterman/dfoliatR_paper](https://github.com/chguiterman/dfoliatR_paper).

Overview of the software
==========================

The `dfoliatR` library requires two sets of tree-ring data to infer defoliation and outbreak events:

* Standardized ring-width series for individual trees of the host species
*	Standardized tree-ring chronology from a local non-host species

Users can develop these data sets in software of their choosing, such as `dplR` [@Bunn2008] or ARSTAN [@arstan]. It is important that the host-tree data include only one tree-ring series per tree. Both `dplR` and ARSTAN have options for averaging multiple sample series into a tree-level series. 

At the heart of `dfoliatR` lies two functions: `defoliate_trees()` and `outbreak()`. These identify defoliation events on individual trees and then composite across multiple trees to identify outbreak events. 



## Identifying Defoliation of Trees

The `defoliate_trees()` function is usually be the point of entry to the dfoliatR library. It performs two processes, removing climate-related growth signals from the host-tree series and then identifying tree-level defoliation events. The climatic or non-defoliation signals in each host-tree series are characterized by a non-host chronology or climate reconstruction. `dfoiatR` removes that non-defoliation signal by subtracting the non-host series from each host-tree series, which generates a residual index. In OUTBREAK, this residual index was termed the "corrected" index. We call it the "growth suppression index" (GSI). The GSI is calculated the same as in OUTBREAK [following @Swetnam1985; @Swetnam1989] for each host tree as 
\begin{align}
\textrm{GSI}_{i} = \textrm{H}_{i} - \left( \textrm{NH}_{i} - \overline{\textrm{NH}} \right) \frac{\sigma_{\textrm{H}}}{\sigma_{\textrm{NH}}} \
\end{align}
where H and NH are the host-tree series and the non-host chronology, in year i, respectively. Only the common period between the host-tree series and the non-host chronology are used in Equation 1. The host and non-host chronologies are brought to common variance by scaling the non-host chronology by its mean ($\overline{\textrm{NH}} \approx 1.0$) and multiplying by the ratio of host and non-host standard deviations ($\frac{\sigma_{\textrm{H}}}{\sigma_{\textrm{NH}}}$), which approximates the variance of the host tree series. 

Negative departures in the normalized GSI that surpass user-defined thresholds in duration and magnitude are defined as *defoliation events*. As in OUTBREAK, magnitude is assessed on a single year within the departure sequence. The default setting is -1.28 (in units of standard deviation), which was previously determined to be representative of WSBW effects (**citation?**). Duration is assessed by examining sequences of negative GSI before and after the year of maximum departure. Each defoliation event is allowed one positive excursion on each side of the maximum departure year. Duration is assessed across the entire sequence that includes up to two positive excursions. The default duration is eight years, as is commonly used in WSBW studies (**citation?**). Different species of defoliation insects vary in the length of defoliation and the degree to which they can suppress tree growth. Researchers can, and should, adjust the duration and magnitude parameters accordingly and critically evaluate the results. 

Diverging from OUTBREAK, `dfoliatR` allows users to extend defoliation events by bridging successive events and also by allowing potentially short-duration events that occur at the end of the series. In cases where two defoliation events are separated by a single year, bridging will link them into a single event (**Show figure?**). We urge careful use of this option because there is no setting to limit the number or length of potentially bridged events. The series end option can be used in cases when the host trees were actively being defoliated at the time of sampling. This option eliminates the duration parameter for an event at the recent end of the series, but all other thresholds apply. The advantage of this parameter is that it can aid in identifying the start-year for the current defoliation event or outbreak, which is both useful in management and allows the current event to be included in return-interval estimates. 


## Inferring Outbreak Events

Defoliation of one or a few trees does not constitute an outbreak. To determine when defoliation becomes an *outbreak event*, `dfoliatR` composites the individual tree defoliation series into a site-level chronology with the `outbreak()` function. Users have options to define the number and/or the proportion of trees required for an event to be considered an outbreak. Three parameters control the whether a defoliation event constitutes an outbreak: the minimum number of trees available, the minimum number of trees recording defoliation, and the percent of trees recording defoliation. The first allows the researcher to make a judgement call as to the confidence ascribed to reduced sample depth toward the ends of their chronologies, thus compensating for the "fading record problem" (**Swetnam and Fritts?**). The second two parameters adjust the scale of defoliation considered to be an outbreak. Absolute numbers of trees and percentages can be applied separately or in conjunction, following filtering conventions in tree ring fire history studies [@Malevich2018]. We urge users to carefully consider the choice of absolute numbers in situations where the number of trees represented in the series varies with time, or the choice of percentages when sample size is small.

Evaluation
==========================

## Approach

We tested `dfoliatR` against OUTBREAK by comparing GSI to corrected indices for individual trees and years, outbreak status for individual trees and years, and percentage of trees recording outbreaks at the site level, using raw ring-width data from 8 sites in British Columbia, Colorado, and New Mexico and author-provided non-host site chronologies.  

We detrended host data for both dfoliatR and OUTBREAK using ARSTAN 6.1 (**downloaded 21 April 2002 from dpl; xxx Ann check the date, as 21 April 2002 is 6.05P**) with default double detrending (128 year wavelength and a 50% smoothing spline) and event thresholds of -1.28 normalized index and 8 years.  Attempts to detrend with ARSTAN 44 in `dplR` were problematic for two reasons.  Some versions of ARSTAN, including ARSTAN 44, do not include an option for producing tree-level averages from multiple cores from the same tree (.tre files).  **More importantly, ring-width indices from ARSTAN 44 truncated the process at either end when sample size fell below 5 xxx (Jodi, what was the minimum?)**, and produced different values for years near the truncation point than did dpl-ARSTAN 6.05P.  The majority of the detrended series values were identical, but not the tails, as the two routines do not use the same data to establish the tails.  These differences produce different GSI (`dfoliatR`) and Corrected Indices (OUTBREAK) values at the tails, sometimes considerably, affecting whether or not outbreak events are inferred early or late in the tree series, timing of the first or last event onset, and subsequent computation of return intervals, duration, and periodicity.  Note that there is nothing particularly important regarding the choice of ARSTAN 6.1 – it is simply the version that the second author used routinely and had available.

## Findings

`dfoliatR` and OUTBREAK compute growth suppresses indices and use them to infer identical tree-level outbreak events, including onset and termination dates and date and magnitude of the maximum growth suppression when `dfoliatR` bridging matches the OUTBREAK protocols.  Once the issues with ARSTAN (described earlier) were resolved, dfoliatR and OUTBREAK produced identical indices at 0.000 precision. 

When inferring outbreak events at the tree level, our initial results did not always match OUTBREAK, leading to development of the bridging option.  Identifying a minimum within a period while allowing for positive excursions is a tricky computation.  OUTBREAK deliberately disallows back-to-back events – after a minimum value within a period of negative values, a second positive index terminates an event.  OUTBREAK does not allow a period of highly negative values to be appended to an earlier outbreak if the intervening period is 1 year, even if those negative values fall below the minimum in the earlier period.  Due in large part to reconstructions using OUTBREAK [see papers cited by @Lynch2012], we now know considerably more about forest defoliator outbreak regimes than we did in the 1980s when OUTBREAK was written.  We think that two prolonged events separated by a single year should in some situations be considered a single outbreak at both the tree and site levels.  This is particularly relevant to western spruce budworm and spruce budworm (*C. fumiferana*), for which regimes have been reconstructed for several geographic areas and for which researchers and forest health experts have gained considerable knowledge (**Sanders et al. 1985, Brookes et al. 1987 and many later publications**).  We now know that the greatest growth suppression often occurs late in the outbreak due to cumulative effects (**rrr**).  We developed the bridging option to permit these periods to be linked to preceding events separated by a single year.

Bridging operates at the tree level in dfoliatR, and these effects generally have minor effects on site-level reconstructions (Fig.Bridging).  Occasionally site-level events are inferred differently (Table.Bridging), and this can affect return interval and duration statistics.

## Best Practice Recommendations

We encourage authors to report software and library version numbers and download dates where applicable. This is standard practice for statistical packages, but has often been ignored for R- and dplR-based analyses.  R-based software evolves over time, and results cannot always be replicated if the software versions are unknown.  Similarly, significant changes (especially fixes) imply that re-analysis of data might differ from earlier published results and interpretations.  Wherever possible, refereed publications supporting the software should be cited.  Our experience with ARSTAN demonstrates the importance of adopting this practice.  In the United States, analytic methods not documented thusly and supported by the literature might be questioned if the results are used in a National Environmental Protection Act (NEPA) process.

We recommend that researchers compare dfoliatR results with and without bridging, and see which option agrees best with known insect biology and ecology.  Bridging may be a logical choice for insects with prolonged non-outbreak periods, such as western spruce budworm, but not for situations where impacted stands barely recover from one outbreak before another begins, such as occurs with pine processionary caterpillars (*Thaumetopoea pityocampa* (Lepidoptera: Thaumetopoeidae)) (**Carus 2004, 2009**). 


Availability and installation
==========================

The `dfoliatR` library [@dfoliatR] is provided free and open source from the Comprehensive R Archive Network (CRAN; [https://cran.r-project.org/](https://cran.r-project.org/)). To install `dfoliatR` from CRAN use

```{r, echo=TRUE, eval=FALSE}
install.packages("dfoliatR")
```

In each `R` session, `dfoliatR` can be loaded via

```{r, echo=TRUE, eval=FALSE}
library(dfoliatR)
```

Development versions of `dfoliatR` are available on GitHub and installed using the `devtools` library,

```{r, echo=TRUE, eval=FALSE}
devtools::install_github("chguiterman/dfoliatR")
```

Issues, bug reports, and ideas for improving `dfoliatR` can be posted to [https://github.com/chguiterman/dfoliatR/issues](https://github.com/chguiterman/dfoliatR/issues). As an Open Source library, we welcome and encourage community involvement in future development. The best ways to contribute to `dfoliatR` are through standard GitHub procedures or by contacting the first author.


Example Usage
==========================

In `dfoliatR` we provide two sets of tree-ring data to aid users in exploring the functions, graphics, and outputs. Each set consists of Douglas-fir (*Pseudotsuga menziesii*) host-tree series, standardized with __________, and a local ponderosa pine (*Pinus ponderosa*) non-host chronology. The non-host ring-width data were standardized by ________ and the chronologies averaged following standard procedures [@Speer2010].  Data from Demijohn Peak (DMJ; 2902 m asl), in the San Juan Mountains of southern Colorado, come from @Ryerson2003. Data from the East Fork site (EF; 2580 m asl) in the Jemez Mountains of northcentral New Mexico were presented by @Swetnam1993. 

## Tree-Level Defoliation Events



## Site-Level Events



Extensions
==========================

* Describe how dfoliatR can be combined with other R libraries
  * Mapping, what else?

References {#references .unnumbered}
==========================
